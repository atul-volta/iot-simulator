<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Multi-Meter Water Simulator!!</title>
  <style>
    body { font-family: Arial; background: #f6f7fb; padding: 2em;}
    .meter-card { background: #fff; border-radius: 8px; box-shadow: 0 1px 4px #bbb; margin-bottom: 2em; padding: 1em; max-width: 500px;}
    label, input, select, button { margin: 0.3em; }
    table { width: 100%; margin-top: 1em;}
    th, td { padding: 0.3em; border: 1px solid #eee; text-align: center;}
    th { background: #e3e8f0;}
  </style>
</head>
<body>
  <h1>IoT Multi-Meter Water Simulator</h1>
  <button onclick="addMeter()">Add Meter</button>
  <div id="meters"></div>

  <script>
    let meters = [];
    let meterCount = 0;

    function addMeter() {
      meterCount++;
      const meterId = "WM-" + String(meterCount).padStart(3, "0");
      meters.push({
        id: meterId,
        profile: "residential",
        interval: 10,
        timer: null,
        totalVolume: 0,
        data: []
      });
      renderMeters();
    }

    function removeMeter(index) {
      clearInterval(meters[index].timer);
      meters.splice(index, 1);
      renderMeters();
    }

    function startMeter(index) {
      const meter = meters[index];
      if (meter.timer) return; // Already running
      meter.timer = setInterval(() => {
        const flowRate = getFlowRate(meter.profile);
        meter.totalVolume += (flowRate * meter.interval) / 60;
        const now = new Date();
        meter.data.unshift({
          time: now.toLocaleTimeString(),
          flow: flowRate,
          total: meter.totalVolume.toFixed(2),
          status: "normal"
        });
        renderMeters();
      }, meter.interval * 1000);
      renderMeters();
    }

    function stopMeter(index) {
      clearInterval(meters[index].timer);
      meters[index].timer = null;
      renderMeters();
    }

    function getFlowRate(profile) {
      const hour = new Date().getHours();
      if (profile === "residential") {
        if ((hour >= 6 && hour <= 8) || (hour >= 18 && hour <= 21))
          return Math.random() * 10 + 5;
        if (hour >= 22 || hour <= 5)
          return Math.random() < 0.8 ? 0 : Math.random() * 2;
        return Math.random() * 3;
      } else {
        if (hour >= 8 && hour <= 18)
          return Math.random() * 8 + 3;
        return Math.random() < 0.9 ? 0 : Math.random() * 2;
      }
    }

    function renderMeters() {
      const metersDiv = document.getElementById("meters");
      metersDiv.innerHTML = "";
      meters.forEach((meter, idx) => {
        const meterDiv = document.createElement("div");
        meterDiv.className = "meter-card";
        meterDiv.innerHTML = `
          <strong>Meter ID:</strong> <input value="${meter.id}" onchange="meters[${idx}].id=this.value">
          <label>Profile:
            <select onchange="meters[${idx}].profile=this.value">
              <option value="residential" ${meter.profile==="residential"?"selected":""}>Residential</option>
              <option value="commercial" ${meter.profile==="commercial"?"selected":""}>Commercial</option>
            </select>
          </label>
          <label>Interval (sec):
            <input type="number" min="1" value="${meter.interval}" onchange="meters[${idx}].interval=parseInt(this.value,10)">
          </label>
          <button onclick="startMeter(${idx})" ${meter.timer ? "disabled" : ""}>Start</button>
          <button onclick="stopMeter(${idx})" ${meter.timer ? "" : "disabled"}>Stop</button>
          <button onclick="removeMeter(${idx})">Remove</button>
          <table>
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>Flow Rate</th>
                <th>Total Volume</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${meter.data.slice(0,5).map(d => `
                <tr>
                  <td>${d.time}</td>
                  <td>${d.flow.toFixed(2)}</td>
                  <td>${d.total}</td>
                  <td>${d.status}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        `;
        metersDiv.appendChild(meterDiv);
      });
    }
    window.addMeter = addMeter;
    window.startMeter = startMeter;
    window.stopMeter = stopMeter;
    window.removeMeter = removeMeter;

    // Add the first meter by default for demo
    addMeter();
  </script>
</body>
</html>
